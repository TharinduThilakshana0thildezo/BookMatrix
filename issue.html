<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue | LibraryOS</title>
    <link rel="icon" type="image/svg+xml" href="./assets/img/educatalog-logo.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="./assets/css/main.css">
    <link rel="stylesheet" href="./assets/css/dark-mode.css">
    <link rel="stylesheet" href="./assets/css/responsive.css">
</head>
<body>
    <div class="hero-bg" aria-hidden="true">
        <span class="hero-blob hero-blob--a"></span>
        <span class="hero-blob hero-blob--b"></span>
        <span class="hero-blob hero-blob--c"></span>
    </div>
    <div data-partial="nav"></div>
    <div class="layout">
        <aside class="sidebar">
            <nav class="sidebar__nav">
                <a class="nav-item" href="./dashboard.html">
                    <span class="nav-item__icon">üè†</span>
                    <span class="nav-item__text">Dashboard</span>
                </a>
                <a class="nav-item" href="./books.html">
                    <span class="nav-item__icon">üìö</span>
                    <span class="nav-item__text">Books</span>
                </a>
                <a class="nav-item nav-item--active" href="./issue.html">
                    <span class="nav-item__icon">üîñ</span>
                    <span class="nav-item__text">My Books</span>
                </a>
                <a class="nav-item" href="./profile.html">
                    <span class="nav-item__icon">üë§</span>
                    <span class="nav-item__text">Profile</span>
                </a>
            </nav>
        </aside>

        <div>
            <main class="content">
                <div class="page-hero">
                    <div>
                        <p class="eyebrow">Circulation</p>
                        <h1 class="page-hero__title">Issue & manage your books</h1>
                        <p class="page-hero__meta">Issue by ISBN in seconds and watch your personal loan list update instantly. Gold accents guide key actions.</p>
                        <div class="page-hero__actions">
                            <a class="btn btn--primary" href="./books.html">Go to book store</a>
                            <a class="btn btn--outline" href="./dashboard.html">Dashboard</a>
                        </div>
                    </div>
                    <div class="pill">Live circulation</div>
                </div>

                <section class="grid grid--two">
                    <div class="glass-panel">
                        <div class="section__title">
                            <span>Issue a book</span>
                            <span class="chip">Instant</span>
                        </div>
                        <form class="form" id="issue-form">
                            <div class="form__group">
                                <label class="form__label" for="book_id">Book ISBN</label>
                                <input class="form__control" type="text" id="book_id" name="book_id" required>
                            </div>
                            <button class="btn btn--primary" type="submit">Issue Book</button>
                        </form>
                    </div>
                    <div class="glass-panel">
                        <div class="section__title">
                            <span>Your books</span>
                            <span class="chip">Live</span>
                        </div>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Book</th>
                                        <th>ISBN</th>
                                        <th>Status</th>
                                        <th>Due</th>
                                    </tr>
                                </thead>
                                <tbody id="my-books-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div data-partial="footer"></div>

    <script type="module">
        import { loadLayout } from './assets/js/layout.js';
        import { requireAuth, bindLogout, getSession } from './assets/js/auth.js';
        import { initThemeToggle } from './assets/js/theme.js';
        import { setPageTransition, showToast } from './assets/js/ui.js';
        import { api } from './assets/js/api.js';

        (async () => {
            requireAuth();
            await loadLayout();
            setPageTransition();
            initThemeToggle();
            bindLogout();

            async function loadMyBooks() {
                try {
                    const rows = await api.fetchMyBooks();
                    const tbody = document.getElementById('my-books-body');
                    if (!tbody) return;
                    tbody.innerHTML = '';
                    rows.forEach((item) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>#${item.issue_id}</td>
                            <td>${item.title || ''}</td>
                            <td>${item.isbn || ''}</td>
                            <td><span class="badge badge--${item.status === 'Return' ? 'success' : 'warning'}">${item.status || ''}</span></td>
                            <td>${item.due_at || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (err) {
                    showToast(err.message || 'Failed to load your books', 'error');
                }
            }

            await loadMyBooks();

            const form = document.getElementById('issue-form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const session = getSession();
                    if (!session || !session.user_unique_id) {
                        showToast('Please log in again', 'error');
                        return;
                    }
                    const data = Object.fromEntries(new FormData(form));
                    const payload = {
                        book_id: data.book_id,
                        user_id: session.user_unique_id
                    };
                    try {
                        await api.issueBook(payload);
                        showToast('Book issued successfully', 'success');
                        form.reset();
                        await loadMyBooks();
                    } catch (err) {
                        showToast(err.message || 'Issue failed', 'error');
                    }
                });
            }
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
